#!/usr/bin/env python3
"""
analyze_topology.py - Rail Topology Analyzer for ck-bench

Author: Vincentwu@zhengytech.com

Analyzes GPU-NIC-Switch topology files generated by ck-bench to verify:
1. Rail alignment (each GPU connects to its expected leaf switch)
2. Connection errors and missing links
3. Port consistency across hosts

Usage:
    python3 analyze_topology.py topology.txt
    python3 analyze_topology.py topology.txt --export result.csv
    python3 analyze_topology.py topology.txt --export result.csv --report summary_report.txt
"""

import re
import sys
import os
from datetime import datetime
from collections import defaultdict

def parse_topology_file(filename):
    """Parse ck-bench topology file format"""
    records = []

    with open(filename, 'r', encoding='utf-8', errors='ignore') as f:
        for line in f:
            line = line.strip()

            # Skip comments, headers, and separators
            if not line or line.startswith('#') or line.startswith('Host') or line.startswith('-'):
                continue

            # Parse space-separated columns: Host GPU NIC Port Switch
            # Example: GPU-1  GPU0  mlx5_0  Port 33  Compute-SU1-Leaf01-A03-40U
            parts = line.split()
            if len(parts) < 4:
                continue

            host = parts[0]
            gpu = parts[1]
            nic = parts[2]

            # Handle Port column (may be "Port XX" or error codes like "NO_LID", "ROUTE_ERR")
            if parts[3] == "Port" and len(parts) >= 5:
                port = parts[4]
                switch = ' '.join(parts[5:]) if len(parts) > 5 else ""
            else:
                # Error case: NO_LID, ROUTE_ERR, PARSE_ERR
                port = parts[3]
                switch = ' '.join(parts[4:]) if len(parts) > 4 else ""

            records.append({
                'host': host,
                'gpu': gpu,
                'nic': nic,
                'port': port,
                'switch': switch
            })

    return records

def extract_leaf_number(switch_name):
    """Extract leaf switch number from switch name

    Examples:
        Compute-SU1-Leaf01-A03-40U -> 1
        Compute-SU2-Leaf09-A03-32U -> 9
        Compute-SU3-Leaf17-D08-40U -> 17
    """
    match = re.search(r'Leaf(\d+)', switch_name)
    if match:
        return int(match.group(1))
    return None

def get_expected_leaf_for_gpu(gpu_id, base_leaf=1):
    """Calculate expected leaf switch for a GPU based on rail design

    Rail design (8 rails):
        GPU0 -> Leaf01 (or base)
        GPU1 -> Leaf02 (or base+1)
        ...
        GPU7 -> Leaf08 (or base+7)
    """
    return base_leaf + gpu_id

def analyze_rail_alignment(records):
    """Analyze rail alignment for all records"""

    stats = {
        'total': 0,
        'ok': 0,
        'rail_error': 0,
        'route_error': 0,
        'no_lid': 0,
        'wrong_switch': 0,  # Connected to non-compute switch (e.g., Storage)
        'hosts_with_errors': set(),
        'switches_used': defaultdict(set),  # switch -> set of hosts
    }

    errors = []
    rail_check_results = []

    # Group records by host to determine base leaf
    hosts_data = defaultdict(list)
    for r in records:
        hosts_data[r['host']].append(r)

    for host, host_records in hosts_data.items():
        # Try to determine the base leaf for this host from GPU0
        base_leaf = None
        for r in host_records:
            if r['gpu'] == 'GPU0' and r['switch'].startswith('Compute'):
                leaf_num = extract_leaf_number(r['switch'])
                if leaf_num:
                    # Base leaf for this SU (round down to nearest 8)
                    # SU1: Leaf01-08, SU2: Leaf09-16, etc.
                    base_leaf = ((leaf_num - 1) // 8) * 8 + 1
                    break

        if not base_leaf:
            base_leaf = 1  # Default assumption

        for r in host_records:
            stats['total'] += 1

            result = {
                'host': r['host'],
                'gpu': r['gpu'],
                'nic': r['nic'],
                'port': r['port'],
                'switch': r['switch'],
                'status': '',
                'expected_leaf': '',
                'actual_leaf': '',
                'message': ''
            }

            # Parse GPU ID
            gpu_match = re.search(r'GPU(\d+)', r['gpu'])
            if not gpu_match:
                continue
            gpu_id = int(gpu_match.group(1))

            # Check for error conditions
            if r['port'] == 'NO_LID':
                stats['no_lid'] += 1
                stats['hosts_with_errors'].add(host)
                result['status'] = 'NO_LID'
                result['message'] = 'ibstat/sminfo failed - IB link down?'
                rail_check_results.append(result)
                errors.append(f"[NO_LID] {host} {r['gpu']} - IB link down")
                continue

            if r['port'] == 'ROUTE_ERR':
                stats['route_error'] += 1
                stats['hosts_with_errors'].add(host)
                result['status'] = 'ROUTE_ERR'
                result['message'] = r['switch']
                rail_check_results.append(result)
                errors.append(f"[ROUTE_ERR] {host} {r['gpu']} - {r['switch']}")
                continue

            if r['port'] == 'PARSE_ERR':
                stats['route_error'] += 1
                stats['hosts_with_errors'].add(host)
                result['status'] = 'PARSE_ERR'
                result['message'] = 'Failed to parse switch info'
                rail_check_results.append(result)
                continue

            # Check if connected to wrong type of switch (e.g., Storage instead of Compute)
            if not r['switch'].startswith('Compute'):
                stats['wrong_switch'] += 1
                stats['hosts_with_errors'].add(host)
                result['status'] = 'WRONG_SWITCH'
                result['message'] = f'Connected to non-compute switch: {r["switch"]}'
                rail_check_results.append(result)
                errors.append(f"[WRONG_SWITCH] {host} {r['gpu']} - {r['switch']}")
                continue

            # Check rail alignment
            actual_leaf = extract_leaf_number(r['switch'])
            expected_leaf = get_expected_leaf_for_gpu(gpu_id, base_leaf)

            result['expected_leaf'] = f'Leaf{expected_leaf:02d}'
            result['actual_leaf'] = f'Leaf{actual_leaf:02d}' if actual_leaf else 'Unknown'

            # Track switch usage
            stats['switches_used'][r['switch']].add(host)

            if actual_leaf == expected_leaf:
                stats['ok'] += 1
                result['status'] = 'OK'
                result['message'] = 'Rail aligned'
            else:
                stats['rail_error'] += 1
                stats['hosts_with_errors'].add(host)
                result['status'] = 'RAIL_ERROR'
                result['message'] = f'Expected Leaf{expected_leaf:02d}, got Leaf{actual_leaf:02d}'
                errors.append(f"[RAIL_ERROR] {host} {r['gpu']} - Expected Leaf{expected_leaf:02d}, got Leaf{actual_leaf:02d}")

            rail_check_results.append(result)

    return stats, errors, rail_check_results

def check_port_consistency(records):
    """Check if same host uses consistent ports across all switches"""
    port_issues = []

    hosts_ports = defaultdict(set)
    for r in records:
        if r['port'].isdigit():
            hosts_ports[r['host']].add(r['port'])

    for host, ports in hosts_ports.items():
        if len(ports) > 1:
            port_issues.append(f"[PORT_MISMATCH] {host} uses multiple ports: {sorted(ports)}")

    return port_issues

def print_report(stats, errors, port_issues):
    """Print analysis report"""
    print("=" * 70)
    print("Rail Topology Analysis Report")
    print("=" * 70)
    print()

    # Summary
    print("Summary Statistics:")
    print("-" * 40)
    print(f"  Total GPU-NIC records : {stats['total']}")
    print(f"  Rail aligned (OK)     : {stats['ok']}")
    print(f"  Rail errors           : {stats['rail_error']}")
    print(f"  Route errors          : {stats['route_error']}")
    print(f"  No LID (link down)    : {stats['no_lid']}")
    print(f"  Wrong switch type     : {stats['wrong_switch']}")
    print(f"  Hosts with issues     : {len(stats['hosts_with_errors'])}")
    print()

    # Success rate
    if stats['total'] > 0:
        success_rate = stats['ok'] / stats['total'] * 100
        print(f"  Success Rate: {success_rate:.1f}%")
    print()

    # Errors
    if errors:
        print("Detected Issues:")
        print("-" * 40)
        for err in errors[:50]:  # Limit to first 50
            print(f"  {err}")
        if len(errors) > 50:
            print(f"  ... and {len(errors) - 50} more errors")
        print()

    # Port consistency
    if port_issues:
        print("Port Consistency Issues:")
        print("-" * 40)
        for issue in port_issues:
            print(f"  {issue}")
        print()

    # Hosts with errors
    if stats['hosts_with_errors']:
        print("Hosts with Issues:")
        print("-" * 40)
        for host in sorted(stats['hosts_with_errors']):
            print(f"  {host}")
        print()

    print("=" * 70)

def export_csv(results, output_file):
    """Export analysis results to CSV"""
    import csv

    fieldnames = ['host', 'gpu', 'nic', 'port', 'switch', 'status', 'expected_leaf', 'actual_leaf', 'message']

    with open(output_file, 'w', encoding='utf-8-sig', newline='') as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(results)

    print(f"Results exported to: {output_file}")


def generate_summary_report(input_file, stats, errors, port_issues, results, output_file):
    """Generate a summary report file"""

    # Calculate statistics
    total = stats['total']
    ok = stats['ok']
    success_rate = (ok / total * 100) if total > 0 else 0

    # Group errors by type
    no_lid_hosts = set()
    route_err_hosts = set()
    wrong_switch_hosts = set()
    rail_err_hosts = set()

    for r in results:
        if r['status'] == 'NO_LID':
            no_lid_hosts.add(r['host'])
        elif r['status'] == 'ROUTE_ERR':
            route_err_hosts.add(r['host'])
        elif r['status'] == 'WRONG_SWITCH':
            wrong_switch_hosts.add(r['host'])
        elif r['status'] == 'RAIL_ERROR':
            rail_err_hosts.add(r['host'])

    # Group rail errors by host for detailed analysis
    rail_errors_by_host = defaultdict(list)
    for r in results:
        if r['status'] == 'RAIL_ERROR':
            rail_errors_by_host[r['host']].append(r)

    # Determine overall status
    if success_rate == 100:
        overall_status = "PASS - All connections are rail-aligned"
    elif success_rate >= 95:
        overall_status = "WARNING - Minor issues detected"
    elif success_rate >= 80:
        overall_status = "ATTENTION - Multiple issues need investigation"
    else:
        overall_status = "FAIL - Significant topology problems"

    with open(output_file, 'w', encoding='utf-8') as f:
        f.write("=" * 70 + "\n")
        f.write("Rail Topology Analysis Summary Report\n")
        f.write("=" * 70 + "\n\n")

        # Meta info
        f.write(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write(f"Input File: {input_file}\n")
        f.write(f"Author: Vincentwu@zhengytech.com\n\n")

        # Overall status
        f.write("-" * 70 + "\n")
        f.write("OVERALL STATUS\n")
        f.write("-" * 70 + "\n")
        f.write(f"  {overall_status}\n")
        f.write(f"  Success Rate: {success_rate:.1f}% ({ok}/{total} connections)\n\n")

        # Summary statistics
        f.write("-" * 70 + "\n")
        f.write("STATISTICS\n")
        f.write("-" * 70 + "\n")
        f.write(f"  Total GPU-NIC Records  : {total}\n")
        f.write(f"  Rail Aligned (OK)      : {ok}\n")
        f.write(f"  Rail Errors            : {stats['rail_error']}\n")
        f.write(f"  Route Errors           : {stats['route_error']}\n")
        f.write(f"  No LID (Link Down)     : {stats['no_lid']}\n")
        f.write(f"  Wrong Switch Type      : {stats['wrong_switch']}\n")
        f.write(f"  Total Hosts with Issues: {len(stats['hosts_with_errors'])}\n\n")

        # Issue breakdown
        if stats['hosts_with_errors']:
            f.write("-" * 70 + "\n")
            f.write("ISSUE BREAKDOWN BY TYPE\n")
            f.write("-" * 70 + "\n\n")

            if no_lid_hosts:
                f.write(f"[NO_LID] IB Link Down ({len(no_lid_hosts)} hosts):\n")
                f.write(f"  Affected: {', '.join(sorted(no_lid_hosts))}\n")
                f.write(f"  Action: Check IB cable connections and port status\n\n")

            if route_err_hosts:
                f.write(f"[ROUTE_ERR] Routing Failed ({len(route_err_hosts)} hosts):\n")
                f.write(f"  Affected: {', '.join(sorted(route_err_hosts))}\n")
                f.write(f"  Action: Check SM configuration and subnet connectivity\n\n")

            if wrong_switch_hosts:
                f.write(f"[WRONG_SWITCH] Connected to Non-Compute Switch ({len(wrong_switch_hosts)} hosts):\n")
                f.write(f"  Affected: {', '.join(sorted(wrong_switch_hosts))}\n")
                f.write(f"  Action: Verify cable connections to correct leaf switches\n\n")

            if rail_err_hosts:
                f.write(f"[RAIL_ERROR] Rail Misalignment ({len(rail_err_hosts)} hosts):\n")
                f.write(f"  Affected: {', '.join(sorted(rail_err_hosts))}\n")
                f.write(f"  Action: Check and swap cables to correct leaf switches\n\n")

        # Detailed rail errors
        if rail_errors_by_host:
            f.write("-" * 70 + "\n")
            f.write("RAIL MISALIGNMENT DETAILS\n")
            f.write("-" * 70 + "\n\n")

            for host in sorted(rail_errors_by_host.keys()):
                errs = rail_errors_by_host[host]
                f.write(f"  {host}:\n")
                for e in errs:
                    f.write(f"    {e['gpu']} ({e['nic']}): {e['message']}\n")
                f.write("\n")

        # Port consistency issues
        if port_issues:
            f.write("-" * 70 + "\n")
            f.write("PORT CONSISTENCY ISSUES\n")
            f.write("-" * 70 + "\n")
            f.write("  Note: Multiple ports may indicate cable routing inconsistency\n\n")
            for issue in port_issues:
                f.write(f"  {issue}\n")
            f.write("\n")

        # Recommendations
        f.write("-" * 70 + "\n")
        f.write("RECOMMENDATIONS\n")
        f.write("-" * 70 + "\n")

        if success_rate == 100:
            f.write("  No action required. All connections are properly aligned.\n")
        else:
            if no_lid_hosts:
                f.write("  1. [HIGH] Check IB link status on affected nodes using 'ibstat'\n")
            if route_err_hosts:
                f.write("  2. [HIGH] Verify SM is running and check 'sminfo' output\n")
            if wrong_switch_hosts:
                f.write("  3. [MEDIUM] Re-route cables from Storage to Compute switches\n")
            if rail_err_hosts:
                f.write("  4. [LOW] Swap cables to correct leaf switches for rail alignment\n")

        f.write("\n" + "=" * 70 + "\n")
        f.write("End of Report\n")
        f.write("=" * 70 + "\n")

    print(f"Summary report saved to: {output_file}")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 analyze_topology.py <topology_file> [options]")
        print()
        print("Options:")
        print("  --export <file.csv>    Export detailed results to CSV")
        print("  --report <file.txt>    Generate summary report file")
        print()
        print("Examples:")
        print("  python3 analyze_topology.py topology.txt")
        print("  python3 analyze_topology.py topology.txt --export rail_analysis.csv")
        print("  python3 analyze_topology.py topology.txt --report summary_report.txt")
        print("  python3 analyze_topology.py topology.txt --export result.csv --report report.txt")
        sys.exit(1)

    input_file = sys.argv[1]
    export_file = None
    report_file = None

    # Parse --export option
    if '--export' in sys.argv:
        idx = sys.argv.index('--export')
        if idx + 1 < len(sys.argv) and not sys.argv[idx + 1].startswith('--'):
            export_file = sys.argv[idx + 1]
        else:
            export_file = 'rail_analysis.csv'

    # Parse --report option
    if '--report' in sys.argv:
        idx = sys.argv.index('--report')
        if idx + 1 < len(sys.argv) and not sys.argv[idx + 1].startswith('--'):
            report_file = sys.argv[idx + 1]
        else:
            report_file = 'summary_report.txt'

    if not os.path.exists(input_file):
        print(f"Error: File not found: {input_file}")
        sys.exit(1)

    print(f"Analyzing topology file: {input_file}")
    print()

    # Parse and analyze
    records = parse_topology_file(input_file)
    stats, errors, results = analyze_rail_alignment(records)
    port_issues = check_port_consistency(records)

    # Print report to console
    print_report(stats, errors, port_issues)

    # Export CSV if requested
    if export_file:
        export_csv(results, export_file)

    # Generate summary report if requested
    if report_file:
        generate_summary_report(input_file, stats, errors, port_issues, results, report_file)

if __name__ == "__main__":
    main()
